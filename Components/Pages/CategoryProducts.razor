@page "/CategoryProducts/{categoryId:int}"
@using CodelineStore.Data.Model
@using Microsoft.AspNetCore.WebUtilities
@using Microsoft.EntityFrameworkCore
@inject ApplicationDbContext DbContext
@inject NavigationManager Navigation

<MudContainer>
    <MudGrid>
        @if (products != null && products.Any())
        {
            @foreach (var product in products)
            {
                <MudItem xs="12" sm="6" md="4" lg="3">
                    <MudCard Class="mx-auto my-2" Style="width: 100%; max-width: 350px;">
                        <MudCardMedia Image="@product.ImagePath"
                                      Style="object-fit: cover; height: 300px; width: 100%;" />
                        <MudCardContent>
                            <MudText Typo="Typo.h5">@product.Name</MudText>
                            <MudText Typo="Typo.body2">Price: $@product.Price</MudText>
                        </MudCardContent>
                        <MudCardActions>
                            <MudButton Variant="Variant.Filled" Color="Color.Primary">
                                Add to Cart
                            </MudButton>
                        </MudCardActions>
                    </MudCard>
                </MudItem>
            }
        }
        else
        {
            <MudText Typo="Typo.h6" Align="Align.Center" Class="mt-4">No products available in this category.</MudText>
        }
    </MudGrid>
</MudContainer>

@code {
    [Parameter]
    public int CategoryId { get; set; }

    private List<ProductWithImage> products;

    protected override async Task OnInitializedAsync()
    {
        // Fetch products for the selected category
        products = await DbContext.Products
            .Where(p => p.CategoryId == CategoryId)
            .Select(p => new ProductWithImage
                {
                    ProductId = p.PId,
                    Name = p.Name,
                    Price = p.Price,
                    ImagePath = p.ProductImages
                        .Select(img => img.imagePath)
                        .FirstOrDefault() ?? "images/default-product.png" // Fallback image
                })
            .ToListAsync();
    }

    public class ProductWithImage
    {
        public int ProductId { get; set; }
        public string Name { get; set; }
        public decimal Price { get; set; }
        public string ImagePath { get; set; }
    }
}
